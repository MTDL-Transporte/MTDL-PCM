{% extends "base.html" %}

{% block title %}Painel PCM - MTDL-PCM{% endblock %}

{% block page_title %}Painel PCM{% endblock %}
{% block breadcrumb_title %}Painel PCM{% endblock %}

{% block content %}
<!-- Métricas principais -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">OS Abertas Hoje</div>
                        <div class="metric-value" id="os-today">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-clipboard-plus fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Em Andamento</div>
                        <div class="metric-value" id="os-progress">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-gear-fill fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Concluídas</div>
                        <div class="metric-value" id="os-done">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-check2-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Equipamentos Ativos</div>
                        <div class="metric-value" id="equipment-active">0</div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-cpu fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alertas e Notificações -->
<div class="row mb-4">
    <div class="col">
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                <strong>Sistema Online!</strong> Todos os sistemas estão funcionando normalmente.
            </div>
        </div>
    </div>
</div>

<!-- Equipamentos Críticos e Atividades Recentes -->
<div class="row mb-4">
    <div class="col-xl-8 col-lg-7 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Equipamentos Críticos</span>
                <button class="btn btn-sm btn-outline-primary">Atualizar</button>
            </div>
            <div class="card-body">
                <p>Status dos equipamentos mais funcionalmente necessários</p>
            </div>
        </div>
    </div>
    <div class="col-xl-4 col-lg-5 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Atividades Recentes</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoUpdateRecent" checked>
                    <label class="form-check-label" for="autoUpdateRecent">Auto</label>
                </div>
            </div>
            <div class="card-body">
                <p>Ver Todas as Atividades</p>
                <small class="text-muted">Última atualização: <span id="recent-update-time">--:--:--</span></small>
            </div>
        </div>
    </div>
</div>

<!-- Performance Mensal -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
        <span>Performance Mensal</span>
        <div class="btn-group btn-group-sm" role="group" aria-label="Intervalo">
            <button type="button" class="btn btn-outline-secondary">Semana</button>
            <button type="button" class="btn btn-outline-secondary active">Mês</button>
            <button type="button" class="btn btn-outline-secondary">Ano</button>
        </div>
    </div>
    <div class="card-body">
        <!-- Placeholder para gráfico de performance -->
        <canvas id="monthlyPerformanceChart" height="120"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Carregar métricas do Painel Admin
async function loadDashboardMetrics() {
    try {
        const response = await axios.get('/api/dashboard/metrics');
        const data = response.data;
        document.getElementById('os-today').textContent = data.today_open_work_orders ?? 0;
        document.getElementById('os-progress').textContent = data.in_progress_work_orders ?? 0;
        document.getElementById('os-done').textContent = data.completed_work_orders ?? 0;
        document.getElementById('equipment-active').textContent = data.active_equipment ?? 0;
    } catch (err) {
        console.warn('Falha ao carregar métricas do painel:', err);
    }
}

// Carregar dados dos gráficos
async function loadCharts() {
    try {
        const response = await axios.get('/api/dashboard/charts/os-by-status');
        const chartData = response.data;
        const ctx = document.getElementById('monthlyPerformanceChart');
        if (!ctx) return;
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels || [],
                datasets: [
                    {
                        label: 'Eficiência (%)',
                        data: chartData.efficiency || [],
                        borderColor: '#4e73df',
                        tension: 0.3
                    },
                    {
                        label: 'Disponibilidade (%)',
                        data: chartData.availability || [],
                        borderColor: '#1cc88a',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    datalabels: { display: false }
                },
                scales: { y: { beginAtZero: true, max: 100 } }
            }
        });
    } catch (err) {
        console.warn('Falha ao carregar gráficos do painel:', err);
    }
}

// Atividades recentes
let recentActivitiesController;
async function loadRecentActivities() {
    try {
        if (recentActivitiesController) {
            try { recentActivitiesController.abort(); } catch (e) {}
        }
        recentActivitiesController = new AbortController();
        const response = await fetch('/api/dashboard/recent-activities', { signal: recentActivitiesController.signal });
        const data = await response.json();
        document.getElementById('recent-update-time').textContent = new Date().toLocaleTimeString();
        // TODO: Renderizar lista de atividades
    } catch (err) {
        console.warn('Falha ao carregar atividades recentes:', err);
    }
}

// Inicializar Painel Admin
loadDashboardMetrics();
loadCharts();
loadRecentActivities();

// Atualizações periódicas
setInterval(loadDashboardMetrics, 30000);
</script>
{% endblock %}