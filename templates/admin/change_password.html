{% extends "base.html" %}
{% block title %}Troca de Senha - Painel Admin - MTDL-PCM{% endblock %}
{% block page_header %}Troca de Senha{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 560px;">
  <div class="card shadow-sm">
    <div class="card-header bg-dark text-white">Atualizar Senha</div>
    <div class="card-body">
      <p class="text-muted">Por segurança, utilize uma senha forte com ao menos 8 caracteres.</p>
      <form id="changeForm">
        <div class="mb-3" id="oldPasswordGroup">
          <label for="old_password" class="form-label">Senha Atual</label>
          <input type="password" class="form-control" id="old_password" name="old_password" />
          <div class="form-text">Obrigatória exceto quando for primeira alteração.</div>
        </div>
        <div class="mb-3">
          <label for="new_password" class="form-label">Nova Senha</label>
          <input type="password" class="form-control" id="new_password" name="new_password" required />
        </div>
        <button type="submit" class="btn btn-primary w-100">Salvar Nova Senha</button>
      </form>
      <div id="changeFeedback" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
  (async function(){
    const feedback = document.getElementById('changeFeedback');
    const form = document.getElementById('changeForm');
    const oldGroup = document.getElementById('oldPasswordGroup');
    let userInfo = null;

    // tenta detectar flag must_change_password
    try {
      const token = (document.cookie.match(/(?:^|; )auth_token=([^;]+)/)||[])[1] || localStorage.getItem('authToken');
      const respMe = await fetch('/api/admin/auth/me', {
        headers: token ? { 'Authorization': 'Bearer ' + token } : {}
      });
      if (respMe.ok) {
        const me = await respMe.json();
        userInfo = me && me.user ? me.user : null;
        if (me && me.user && me.user.must_change_password) {
          oldGroup.style.display = 'none';
        }
      } else if (respMe.status === 401) {
        window.location.href = '/admin/login';
        return;
      }
    } catch (e) { /* silencioso */ }

    form.addEventListener('submit', async function(e){
      e.preventDefault();
      feedback.textContent = '';
      const token = (document.cookie.match(/(?:^|; )auth_token=([^;]+)/)||[])[1] || localStorage.getItem('authToken');
      const old_password = document.getElementById('old_password').value;
      const new_password = document.getElementById('new_password').value;
      try {
        const resp = await fetch('/api/admin/auth/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': 'Bearer ' + token } : {})
          },
          body: JSON.stringify({ old_password, new_password })
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({ detail: 'Erro ao alterar senha' }));
          throw new Error(err.detail || 'Falha ao alterar senha');
        }
        feedback.innerHTML = '<div class="alert alert-success">Senha atualizada com sucesso!</div>';
        const user = userInfo || {};
        const modules = Array.isArray(user.modules) ? user.modules : [];
        let target = '/dashboard';
        if (user.is_admin) {
          target = '/admin';
        } else if (modules.includes('construction')) {
          target = '/construction/appropriation';
        } else if (modules.includes('maintenance')) {
          target = '/maintenance/work-orders';
        } else if (modules.includes('warehouse')) {
          target = '/warehouse/purchase_orders';
        } else if (modules.includes('hr')) {
          target = '/hr/employees';
        }
        setTimeout(() => { window.location.href = target; }, 800);
      } catch (err) {
        feedback.innerHTML = '<div class="alert alert-danger">' + (err.message || 'Erro') + '</div>';
      }
    });
  })();
</script>
{% endblock %}